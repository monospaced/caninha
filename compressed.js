function $(a){return typeof a=="string"?document.getElementById(a):a}function clone(a){var b={};for(property in a)b[property]=a[property];return b}function insertElement(a,b,c,d,e){var f=document.createElement(b);return c&&(f.id=c),d&&(f.className=d),e&&insertText(f,e),a&&a.appendChild(f),f}function insertText(a,b){return a.appendChild(document.createTextNode(b))}function removeChildren(a){while(a.hasChildNodes())a.removeChild(a.firstChild)}function setPageElement(a,b,c){if(place=$(a))removeChildren(place),tale.has(b)?new Wikifier(place,tale.get(b).text):new Wikifier(place,c)}function addStyle(a){if(document.createStyleSheet)document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style>"+a+"</style>");else{var b=document.createElement("style");b.type="text/css",b.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(b)}}function throwError(a,b){new Wikifier(a,"'' @@ "+b+" @@ ''")}function Wikifier(a,b){this.source=b,this.output=a,this.nextMatch=0,this.assembleFormatterMatches(Wikifier.formatters),this.subWikify(this.output)}function fade(a,b){function g(){c+=.05*e,h(d,Math.easeInOut(c));if(e==1&&c>=1||e==-1&&c<=0)console.log("swapping fader proxy out"),a.style.visibility=b.fade=="in"?"visible":"hidden",d.parentNode.replaceChild(a,d),delete d,window.clearInterval(f),b.onComplete&&b.onComplete()}function h(a,b){var c=Math.floor(b*100);a.style.zoom=1,a.style.filter="alpha(opacity="+c+")",a.style.opacity=b}var c,d=a.cloneNode(!0),e=b.fade=="in"?1:-1;a.parentNode.replaceChild(d,a),b.fade=="in"?(c=0,d.style.visibility="visible"):c=1,h(d,c);var f=window.setInterval(g,25)}function scrollWindowTo(a){function h(){e+=.1,window.scrollTo(0,b+f*d*Math.easeInOut(e)),e>=1&&window.clearInterval(g)}function i(a){var b=j(a),c=b+a.offsetHeight,d=window.scrollY?window.scrollY:document.body.scrollTop,e=window.innerHeight?window.innerHeight:document.body.clientHeight,f=d+e;return b<d?b:c>f?a.offsetHeight<e?b-(e-a.offsetHeight)+20:b:b}function j(a){var b=0;while(a.offsetParent)b+=a.offsetTop,a=a.offsetParent;return b}var b=window.scrollY?window.scrollY:document.body.scrollTop,c=i(a),d=Math.abs(b-c),e=0,f=b>c?-1:1,g=window.setInterval(h,25)}function History(){this.history=[{passage:null,variables:{},hash:null}]}function Passage(a,b,c){this.title=a,b?(this.id=c,this.initialText=this.text=Passage.unescapeLineBreaks(b.firstChild?b.firstChild.nodeValue:""),this.tags=b.getAttribute("tags"),typeof this.tags=="string"?this.tags=this.tags.readBracketedList():this.tags=[]):(this.initialText=this.text="@@This passage does not exist.@@",this.tags=[])}function Tale(){this.passages={},document.normalize&&document.normalize();var a=$("storeArea").childNodes;for(var b=0;b<a.length;b++){var c=a[b];c.getAttribute&&(tiddlerTitle=c.getAttribute("tiddler"))&&(this.passages[tiddlerTitle]=new Passage(tiddlerTitle,c,b))}this.title="Sugarcane",this.passages.StoryTitle&&(this.title=this.passages.StoryTitle.text)}function main(){tale=new Tale,document.title=tale.title,setPageElement("storyTitle","StoryTitle","Untitled Story"),tale.has("StoryAuthor")&&($("titleSeparator").innerHTML="<br />",setPageElement("storyAuthor","StoryAuthor","")),tale.has("StoryMenu")&&($("storyMenu").style.display="block",setPageElement("storyMenu","StoryMenu",""));for(macro in macros)typeof macro.init=="function"&&macro.init();var styles=tale.lookup("tags","stylesheet");for(var i=0;i<styles.length;i++)addStyle(styles[i].text);var scripts=tale.lookup("tags","script");for(var i=0;i<scripts.length;i++)try{eval(scripts[i].text)}catch(e){alert("There is a technical problem with this story ("+scripts[i].title+": "+e.message+"). You may be able "+"to continue reading, but all parts of the story may not "+"work properly.")}state=new History,state.init(),console.log("init complete",tale,state)}Math.easeInOut=function(a){return 1-(Math.cos(a*Math.PI)+1)/2},String.prototype.readMacroParams=function(){var a=new RegExp("(?:\\s*)(?:(?:\"([^\"]*)\")|(?:'([^']*)')|(?:\\[\\[([^\\]]*)\\]\\])|([^\"'\\s]\\S*))","mg"),b=[];do{var c=a.exec(this);c&&(c[1]?b.push(c[1]):c[2]?b.push(c[2]):c[3]?b.push(c[3]):c[4]&&b.push(c[4]))}while(c);return b},String.prototype.readBracketedList=function(){var a="\\[\\[([^\\]]+)\\]\\]",b="[^\\s$]+",c="(?:"+a+")|("+b+")",d=new RegExp(c,"mg"),e=[];do{var f=d.exec(this);f&&(f[1]?e.push(f[1]):f[2]&&e.push(f[2]))}while(f);return e},String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){b=b==null?0:b;var c=this.length;for(var d=b;d<c;d++)if(this[d]==a)return d;return-1}),Wikifier.prototype.assembleFormatterMatches=function(a){this.formatters=[];var b=[];for(var c=0;c<a.length;c++)b.push("("+a[c].match+")"),this.formatters.push(a[c]);this.formatterRegExp=new RegExp(b.join("|"),"mg")},Wikifier.prototype.subWikify=function(a,b){var c=this.output;this.output=a;var d=b?new RegExp("("+b+")","mg"):null;do{this.formatterRegExp.lastIndex=this.nextMatch,d&&(d.lastIndex=this.nextMatch);var e=this.formatterRegExp.exec(this.source),f=d?d.exec(this.source):null;if(f&&(!e||f.index<=e.index)){f.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,f.index),this.matchStart=f.index,this.matchLength=f[1].length,this.matchText=f[1],this.nextMatch=f.index+f[1].length,this.output=c;return}if(e){e.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,e.index),this.matchStart=e.index,this.matchLength=e[0].length,this.matchText=e[0],this.nextMatch=this.formatterRegExp.lastIndex;var g=-1;for(var h=1;h<e.length;h++)e[h]&&(matchingFormatter=h-1);matchingFormatter!=-1&&this.formatters[matchingFormatter].handler(this)}}while(f||e);this.nextMatch<this.source.length&&(this.outputText(this.output,this.nextMatch,this.source.length),this.nextMatch=this.source.length),this.output=c},Wikifier.prototype.outputText=function(a,b,c){insertText(a,this.source.substring(b,c))},Wikifier.prototype.fullArgs=function(){var a=this.source.indexOf(" ",this.matchStart),b=this.source.indexOf(">>",this.matchStart);return Wikifier.parse(this.source.slice(a,b))},Wikifier.parse=function(a){var b=a.replace(/\$/g,"state.history[0].variables.");return b=b.replace(/\beq\b/gi," == "),b=b.replace(/\bneq\b/gi," != "),b=b.replace(/\bgt\b/gi," > "),b=b.replace(/\beq\b/gi," == "),b=b.replace(/\bneq\b/gi," != "),b=b.replace(/\bgt\b/gi," > "),b=b.replace(/\bgte\b/gi," >= "),b=b.replace(/\blt\b/gi," < "),b=b.replace(/\blte\b/gi," <= "),b=b.replace(/\band\b/gi," && "),b=b.replace(/\bor\b/gi," || "),b=b.replace(/\bnot\b/gi," ! "),b},Wikifier.formatHelpers={charFormatHelper:function(a){var b=insertElement(a.output,this.element);a.subWikify(b,this.terminator)},inlineCssHelper:function(a){var b=[],c="(?:("+Wikifier.textPrimitives.anyLetter+"+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:("+Wikifier.textPrimitives.anyLetter+"+):([^;\\|\\n]+);)",d=new RegExp(c,"mg"),e=!1;do{d.lastIndex=a.nextMatch;var f=d.exec(a.source),g=f&&f.index==a.nextMatch;if(g){var h,i;e=!0,f[1]?(h=f[1].unDash(),i=f[2]):(h=f[3].unDash(),i=f[4]);switch(h){case"bgcolor":h="backgroundColor"}b.push({style:h,value:i}),a.nextMatch=f.index+f[0].length}}while(g);return b},monospacedByLineHelper:function(a){var b=new RegExp(this.lookahead,"mg");b.lastIndex=a.matchStart;var c=b.exec(a.source);if(c&&c.index==a.matchStart){var d=c[1];navigator.userAgent.indexOf("msie")!=-1&&navigator.userAgent.indexOf("opera")==-1&&(d=d.replace(/\n/g,"\r"));var e=insertElement(a.output,"pre",null,null,d);a.nextMatch=c.index+c[0].length}}},Wikifier.formatters=[{name:"table",match:"^\\|(?:[^\\n]*)\\|(?:[fhc]?)$",lookahead:"^\\|([^\\n]*)\\|([fhc]?)$",rowTerminator:"\\|(?:[fhc]?)$\\n?",cellPattern:"(?:\\|([^\\n\\|]*)\\|)|(\\|[fhc]?$\\n?)",cellTerminator:"(?:\\x20*)\\|",rowTypes:{c:"caption",h:"thead","":"tbody",f:"tfoot"},handler:function(a){var b=insertElement(a.output,"table");a.nextMatch=a.matchStart;var c=new RegExp(this.lookahead,"mg"),d=null,e,f,g,h=[],i=0;do{c.lastIndex=a.nextMatch;var j=c.exec(a.source),k=j&&j.index==a.nextMatch;k&&(e=j[2],e!=d&&(f=insertElement(b,this.rowTypes[e])),d=e,d=="c"?(i==0?f.setAttribute("align","top"):f.setAttribute("align","bottom"),a.nextMatch=a.nextMatch+1,a.subWikify(f,this.rowTerminator)):(g=insertElement(f,"tr"),this.rowHandler(a,g,h)),i++)}while(k)},rowHandler:function(a,b,c){var d=0,e=1,f=new RegExp(this.cellPattern,"mg");do{f.lastIndex=a.nextMatch;var g=f.exec(a.source);matched=g&&g.index==a.nextMatch;if(matched){if(g[1]=="~"){var h=c[d];h&&(h.rowCount++,h.element.setAttribute("rowSpan",h.rowCount),h.element.setAttribute("rowspan",h.rowCount),h.element.valign="center"),a.nextMatch=g.index+g[0].length-1}else if(g[1]==">")e++,a.nextMatch=g.index+g[0].length-1;else{if(g[2]){a.nextMatch=g.index+g[0].length;break}var i=!1,j=!1;a.nextMatch++;var k=Wikifier.formatHelpers.inlineCssHelper(a);while(a.source.substr(a.nextMatch,1)==" ")i=!0,a.nextMatch++;var l;a.source.substr(a.nextMatch,1)=="!"?(l=insertElement(b,"th"),a.nextMatch++):l=insertElement(b,"td"),c[d]={rowCount:1,element:l},lastColCount=1,lastColElement=l,e>1&&(l.setAttribute("colSpan",e),l.setAttribute("colspan",e),e=1);for(var m=0;m<k.length;m++)l.style[k[m].style]=k[m].value;a.subWikify(l,this.cellTerminator),a.matchText.substr(a.matchText.length-2,1)==" "&&(j=!0),i&&j?l.align="center":i?l.align="right":j&&(l.align="left"),a.nextMatch=a.nextMatch-1}d++}}while(matched)}},{name:"rule",match:"^----$\\n?",handler:function(a){insertElement(a.output,"hr")}},{name:"emdash",match:"--",handler:function(a){var b=insertElement(a.output,"span");b.innerHTML="&mdash;"}},{name:"heading",match:"^!{1,5}",terminator:"\\n",handler:function(a){var b=insertElement(a.output,"h"+a.matchLength);a.subWikify(b,this.terminator)}},{name:"monospacedByLine",match:"^\\{\\{\\{\\n",lookahead:"^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)",handler:Wikifier.formatHelpers.monospacedByLineHelper},{name:"monospacedByLineForPlugin",match:"^//\\{\\{\\{\\n",lookahead:"^//\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^//\\}\\}\\}$\\n?)",handler:Wikifier.formatHelpers.monospacedByLineHelper},{name:"wikifyCommentForPlugin",match:"^/\\*\\*\\*\\n",terminator:"^\\*\\*\\*/\\n",handler:function(a){a.subWikify(a.output,this.terminator)}},{name:"quoteByBlock",match:"^<<<\\n",terminator:"^<<<\\n",handler:function(a){var b=insertElement(a.output,"blockquote");a.subWikify(b,this.terminator)}},{name:"quoteByLine",match:"^>+",terminator:"\\n",element:"blockquote",handler:function(a){var b=new RegExp(this.match,"mg"),c=[a.output],d=0,e=a.matchLength,f;do{if(e>d)for(f=d;f<e;f++)c.push(insertElement(c[c.length-1],this.element));else if(e<d)for(f=d;f>e;f--)c.pop();d=e,a.subWikify(c[c.length-1],this.terminator),insertElement(c[c.length-1],"br"),b.lastIndex=a.nextMatch;var g=b.exec(a.source),h=g&&g.index==a.nextMatch;h&&(e=g[0].length,a.nextMatch+=g[0].length)}while(h)}},{name:"list",match:"^(?:(?:\\*+)|(?:#+))",lookahead:"^(?:(\\*+)|(#+))",terminator:"\\n",outerElement:"ul",itemElement:"li",handler:function(a){var b=new RegExp(this.lookahead,"mg");a.nextMatch=a.matchStart;var c=[a.output],d=null,e,f=0,g,h;do{b.lastIndex=a.nextMatch;var i=b.exec(a.source),j=i&&i.index==a.nextMatch;if(j){i[1]&&(e="ul"),i[2]&&(e="ol"),g=i[0].length,a.nextMatch+=i[0].length;if(g>f)for(h=f;h<g;h++)c.push(insertElement(c[c.length-1],e));else if(g<f)for(h=f;h>g;h--)c.pop();else g==f&&e!=d&&(c.pop(),c.push(insertElement(c[c.length-1],e)));f=g,d=e;var k=insertElement(c[c.length-1],"li");a.subWikify(k,this.terminator)}}while(j)}},{name:"prettyLink",match:"\\[\\[",lookahead:"\\[\\[([^\\|\\]]*?)(?:(\\]\\])|(\\|(.*?)\\]\\]))",terminator:"\\|",handler:function(a){var b=new RegExp(this.lookahead,"mg");b.lastIndex=a.matchStart;var c=b.exec(a.source);if(c&&c.index==a.matchStart&&c[2]){var d=Wikifier.createInternalLink(a.output,c[1]);a.outputText(d,a.nextMatch,a.nextMatch+c[1].length),a.nextMatch+=c[1].length+2}else if(c&&c.index==a.matchStart&&c[3]){var e;tale.has(c[4])?e=Wikifier.createInternalLink(a.output,c[4]):e=Wikifier.createExternalLink(a.output,c[4]),a.outputText(e,a.nextMatch,a.nextMatch+c[1].length),a.nextMatch=c.index+c[0].length}}},{name:"urlLink",match:"(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)",handler:function(a){var b=Wikifier.createExternalLink(a.output,a.matchText);a.outputText(b,a.matchStart,a.nextMatch)}},{name:"image",match:"\\[(?:[<]{0,1})(?:[>]{0,1})[Ii][Mm][Gg]\\[",lookahead:"\\[([<]{0,1})([>]{0,1})[Ii][Mm][Gg]\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\]?)?(\\])",handler:function(a){var b=new RegExp(this.lookahead,"mg");b.lastIndex=a.matchStart;var c=b.exec(a.source);if(c&&c.index==a.matchStart){var d=a.output;c[5]&&(tale.has(c[5])?d=Wikifier.createInternalLink(a.output,c[5]):d=Wikifier.createExternalLink(a.output,c[5]));var e=insertElement(d,"img");c[1]?e.align="left":c[2]&&(e.align="right"),c[3]&&(e.title=c[3]),e.src=c[4],a.nextMatch=c.index+c[0].length}}},{name:"macro",match:"<<",lookahead:"<<([^>\\s]+)(?:\\s*)([^>]*)>>",handler:function(a){var b=new RegExp(this.lookahead,"mg");b.lastIndex=a.matchStart;var c=b.exec(a.source);if(c&&c.index==a.matchStart&&c[1]){var d=c[2].readMacroParams();a.nextMatch=c.index+c[0].length;try{var e=macros[c[1]];e&&e.handler?e.handler(a.output,c[1],d,a):insertElement(a.output,"span",null,"marked","macro not found: "+c[1])}catch(f){throwError(a.output,"Error executing macro "+c[1]+": "+f.toString())}}}},{name:"html",match:"<[Hh][Tt][Mm][Ll]>",lookahead:"<[Hh][Tt][Mm][Ll]>((?:.|\\n)*?)</[Hh][Tt][Mm][Ll]>",handler:function(a){var b=new RegExp(this.lookahead,"mg");b.lastIndex=a.matchStart;var c=b.exec(a.source);if(c&&c.index==a.matchStart){var d=insertElement(a.output,"span");d.innerHTML=c[1],a.nextMatch=c.index+c[0].length}}},{name:"commentByBlock",match:"/%",lookahead:"/%((?:.|\\n)*?)%/",handler:function(a){var b=new RegExp(this.lookahead,"mg");b.lastIndex=a.matchStart;var c=b.exec(a.source);c&&c.index==a.matchStart&&(a.nextMatch=c.index+c[0].length)}},{name:"boldByChar",match:"''",terminator:"''",element:"strong",handler:Wikifier.formatHelpers.charFormatHelper},{name:"strikeByChar",match:"==",terminator:"==",element:"strike",handler:Wikifier.formatHelpers.charFormatHelper},{name:"underlineByChar",match:"__",terminator:"__",element:"u",handler:Wikifier.formatHelpers.charFormatHelper},{name:"italicByChar",match:"//",terminator:"//",element:"em",handler:Wikifier.formatHelpers.charFormatHelper},{name:"subscriptByChar",match:"~~",terminator:"~~",element:"sub",handler:Wikifier.formatHelpers.charFormatHelper},{name:"superscriptByChar",match:"\\^\\^",terminator:"\\^\\^",element:"sup",handler:Wikifier.formatHelpers.charFormatHelper},{name:"monospacedByChar",match:"\\{\\{\\{",lookahead:"\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}",handler:function(a){var b=new RegExp(this.lookahead,"mg");b.lastIndex=a.matchStart;var c=b.exec(a.source);if(c&&c.index==a.matchStart){var d=insertElement(a.output,"code",null,null,c[1]);a.nextMatch=c.index+c[0].length}}},{name:"styleByChar",match:"@@",terminator:"@@",lookahead:"(?:([^\\(@]+)\\(([^\\)]+)(?:\\):))|(?:([^:@]+):([^;]+);)",handler:function(a){var b=insertElement(a.output,"span",null,null,null),c=Wikifier.formatHelpers.inlineCssHelper(a);if(c.length==0)b.className="marked";else for(var d=0;d<c.length;d++)b.style[c[d].style]=c[d].value;a.subWikify(b,this.terminator)}},{name:"lineBreak",match:"\\n",handler:function(a){insertElement(a.output,"br")}}],Wikifier.textPrimitives={anyDigit:"[0-9]",anyNumberChar:"[0-9\\.E]",urlPattern:"(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)"},Wikifier.createInternalLink=function(a,b){var c=insertElement(a,"a",b);return c.href="javascript:void(0)",tale.has(b)?c.className="internalLink":c.className="brokenLink",c.onclick=function(){state.display(b,c)},a&&a.appendChild(c),c},Wikifier.createExternalLink=function(a,b){var c=insertElement(a,"a");return c.href=b,c.className="externalLink",c.target="_blank",a&&a.appendChild(c),c},(new RegExp("[\u0150\u0170]","g")).test("\u0150")?(Wikifier.textPrimitives.upperLetter="[A-Z\u00c0-\u00de\u0150\u0170]",Wikifier.textPrimitives.lowerLetter="[a-z\u00df-\u00ff_0-9\\-\u0151\u0171]",Wikifier.textPrimitives.anyLetter="[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-\u0150\u0170\u0151\u0171]"):(Wikifier.textPrimitives.upperLetter="[A-Z\u00c0-\u00de]",Wikifier.textPrimitives.lowerLetter="[a-z\u00df-\u00ff_0-9\\-]",Wikifier.textPrimitives.anyLetter="[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-]"),History.prototype.init=function(){var a=this;this.restore()||this.display("Start",null),this.hash=window.location.hash,this.interval=window.setInterval(function(){a.watchHash.apply(a)},250)},History.prototype.display=function(a,b,c){console.log('displaying "'+a+'" '+(c||"")+" from ",b);var d=tale.get(a);this.history.unshift({passage:d,variables:clone(this.history[0].variables)}),this.history[0].hash=this.save();var e=d.render();c!="offscreen"&&(removeChildren($("passages")),$("passages").appendChild(e),c!="quietly"&&fade(e,{fade:"in"}));if(c=="quietly"||c=="offscreen")e.style.visibility="visible";return c!="offscreen"&&(document.title=tale.title,this.hash=this.save(),d.title!="Start"&&(document.title+=": "+d.title,window.location.hash=this.hash),window.scroll(0,0)),e},History.prototype.restart=function(){window.location.hash=""},History.prototype.save=function(a){var b="";for(var c=this.history.length-1;c>=0;c--)this.history[c].passage&&this.history[c].passage.id&&(b+=this.history[c].passage.id.toString(36)+".");return"#"+b.substr(0,b.length-1)},History.prototype.restore=function(){try{if(window.location.hash==""||window.location.hash=="#")return!1;var a=window.location.hash.replace("#","").split("."),b=[];for(var c=0;c<a.length;c++){var d=parseInt(a[c],36);if(!tale.has(d))return!1;console.log("restoring id "+d);var e=c==a.length-1?"":"offscreen";b.unshift(this.display(d,null,e))}return!0}catch(f){return console.log("restore failed",f),!1}},History.prototype.watchHash=function(){window.location.hash!=this.hash&&(console.log("new hash: "+window.location.hash+", was "+this.hash),window.location.hash!=""&&window.location.hash!="#"?(this.history=[{passage:null,variables:{}}],removeChildren($("passages")),$("passages").style.visibility="hidden",this.restore()||alert("The passage you had previously visited could not be found."),$("passages").style.visibility="visible"):window.location.reload(),this.hash=window.location.hash)},version.extensions.backMacro={major:1,minor:0,revision:0},macros.back={handler:function(a,b,c){var d="";if(c[0]){for(var e=0;e<state.history.length;e++)if(state.history[e].passage.title==c[0]){d=state.history[e].hash;break}}else if(state.history[1])d=state.history[1].hash;else{throwError(a,"can't go back from the first passage read");return}if(d==""){throwError(a,"can't find passage \""+c[0]+'" in history');return}el=document.createElement("a"),el.className="back",el.href=d,el.innerHTML="<b>&laquo;</b> Back",a.appendChild(el)}},version.extensions.displayMacro={major:1,minor:0,revision:0},macros.display={handler:function(a,b,c){console.log('<<display>>ing "'+c[0]+'"'),new Wikifier(a,tale.get(c[0]).text),console.log('<<display>> of "'+c[0]+'" complete')}},version.extensions.actionsMacro={major:1,minor:2,revision:0},macros.actions={handler:function(a,b,c){var d=insertElement(a,"ul");state.history[0].variables["actions clicked"]||(state.history[0].variables["actions clicked"]={});for(var e=0;e<c.length;e++){if(state.history[0].variables["actions clicked"][c[e]])continue;var f=insertElement(d,"li"),g=Wikifier.createInternalLink(f,c[e]);insertText(g,c[e]),g.onclick=function(){state.history[0].variables["actions clicked"][this.id]=!0,state.display(this.id,g)}}}},version.extensions.printMacro={major:1,minor:1,revision:0},macros.print={handler:function(place,macroName,params,parser){try{var output=eval(parser.fullArgs());output&&new Wikifier(place,output.toString())}catch(e){throwError(place,"bad expression: "+e.message)}}},version.extensions.setMacro={major:1,minor:1,revision:0},macros.set={handler:function(a,b,c,d){macros.set.run(d.fullArgs())},run:function(expression){try{return eval(Wikifier.parse(expression))}catch(e){throwError(place,"bad expression: "+e.message)}}},version.extensions.ifMacros={major:1,minor:0,revision:0},macros["if"]={handler:function(place,macroName,params,parser){var condition=parser.fullArgs(),srcOffset=parser.source.indexOf(">>",parser.matchStart)+2,src=parser.source.slice(srcOffset),endPos=-1,trueClause="",falseClause="";for(var i=0,nesting=1,currentClause=!0;i<src.length;i++){if(src.substr(i,9)=="<<endif>>"){nesting--;if(nesting==0){endPos=srcOffset+i+9;break}}src.substr(i,8)=="<<else>>"&&nesting==1&&(currentClause="false",i+=8),src.substr(i,5)=="<<if "&&nesting++,currentClause==!0?trueClause+=src.charAt(i):falseClause+=src.charAt(i)}try{eval(condition)?new Wikifier(place,trueClause.trim()):new Wikifier(place,falseClause.trim()),endPos!=-1?parser.nextMatch=endPos:throwError(place,"can't find matching endif")}catch(e){throwError(place,"bad condition: "+e.message)}}},macros["else"]=macros.endif={handler:function(){}},version.extensions.rememberMacro={major:1,minor:1,revision:0},macros.remember={handler:function(place,macroName,params,parser){var statement=parser.fullArgs(),expire=new Date,variable,value;macros.set.run(statement);var variableSigil=Wikifier.parse("$");variableSigil=variableSigil.replace("[","\\["),variableSigil=variableSigil.replace("]","\\]"),variable=statement.match(new RegExp(variableSigil+"(\\w+)","i"))[1],value=eval(Wikifier.parse("$"+variable));switch(typeof value){case"string":value='"'+value.replace(/"/g,'\\"')+'"';break;case"number":case"boolean":break;default:throwError(place,"can't remember $"+variable+" ("+typeof value+")");return}expire.setYear(expire.getFullYear()+1),document.cookie=macros.remember.prefix+variable+"="+value+"; expires="+expire.toGMTString()},init:function(){tale.has("StoryTitle")?macros.remember.prefix=tale.get("StoryTitle").text+"_":macros.remember.prefix="__jonah_";var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var bits=cookies[i].split("=");if(bits[0].trim().indexOf(this.prefix)==0){var statement=cookies[i].replace(this.prefix,"$");eval(Wikifier.parse(statement))}}}},version.extensions.SilentlyMacro={major:1,minor:0,revision:0},macros.silently={handler:function(a,b,c,d){var e=insertElement(null,"div"),f=d.source.indexOf(">>",d.matchStart)+2,g=d.source.slice(f),h=-1,i="";for(var j=0;j<g.length;j++)g.substr(j,15)=="<<endsilently>>"?h=f+j+15:i+=g.charAt(j);h!=-1?(new Wikifier(e,i),d.nextMatch=h):throwError(a,"can't find matching endsilently"),delete e}},macros.endsilently={handler:function(){}},version.extensions.choiceMacro={major:1,minor:0,revision:0},macros.choice={handler:function(a,b,c){Wikifier.createInternalLink(a,c[0])}},Passage.prototype.render=function(){var a=insertElement(null,"div","passage"+this.title,"passage");a.style.visibility="hidden",insertElement(a,"div","","header");var b=insertElement(a,"div","","content");return new Wikifier(b,this.text),insertElement(a,"div","","footer"),console.log(a),a},Passage.prototype.reset=function(){console.log('resetting "'+this.title+'"'),this.text=this.initialText},Passage.prototype.excerpt=function(){var a=this.text.replace(/<<.*?>>/g,"");a=a.replace(/!.*?\n/g,""),a=a.replace(/[\[\]\/]/g,"");var b=a.match(/(.*?\s.*?\s.*?\s.*?\s.*?\s.*?\s.*?)\s/);return b[1]+"..."},Passage.unescapeLineBreaks=function(a){return a&&a!=""?a.replace(/\\n/mg,"\n").replace(/\\/mg,"\\").replace(/\r/mg,""):""},Tale.prototype.has=function(a){if(typeof a=="string")return this.passages[a]!=null;for(i in this.passages)if(this.passages[i].id==a)return!0;return!1},Tale.prototype.get=function(a){if(typeof a=="string")return this.passages[a]||new Passage(a);for(i in this.passages)if(this.passages[i].id==a)return this.passages[i]},Tale.prototype.lookup=function(a,b,c){var d=[];for(var e in this.passages){var f=this.passages[e],g=!1;for(var h=0;h<f[a].length;h++)f[a][h]==b&&d.push(f)}return c||(c="title"),d.sort(function(a,b){return a[c]==b[c]?0:a[c]<b[c]?-1:1}),d},Tale.prototype.reset=function(){console.log("resetting all passages");for(i in this.passages)this.passages[i].reset()};var version={major:2,minor:0,revision:0,date:new Date("July 30, 2007"),extensions:{}},tale,state,macros={};Interface={init:function(){console.log("Interface.init()"),main(),$("snapback").onclick=Interface.showSnapback,$("restart").onclick=Interface.restart,$("share").onclick=Interface.showShare},restart:function(){confirm("Are you sure you want to restart this story?")&&state.restart()},showShare:function(a){Interface.hideAllMenus(),Interface.showMenu(a,$("shareMenu"))},showSnapback:function(a){Interface.hideAllMenus(),Interface.buildSnapback(),Interface.showMenu(a,$("snapbackMenu"))},buildSnapback:function(){var a=!1;removeChildren($("snapbackMenu"));for(var b=state.history.length-1;b>=0;b--)if(state.history[b].passage&&state.history[b].passage.tags.indexOf("bookmark")!=-1){var c=document.createElement("div");c.hash=state.history[b].hash,c.onclick=function(){window.location.hash=this.hash},c.innerHTML=state.history[b].passage.excerpt(),$("snapbackMenu").appendChild(c),a=!0}if(!a){var c=document.createElement("div");c.innerHTML="<i>No passages available</i>",$("snapbackMenu").appendChild(c)}},hideAllMenus:function(){$("shareMenu").style.display="none",$("snapbackMenu").style.display="none"},showMenu:function(a,b){a||(a=window.event);var c={x:0,y:0};if(a.pageX||a.pageY)c.x=a.pageX,c.y=a.pageY;else if(a.clientX||a.clientY)c.x=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c.y=a.clientY+document.body.scrollTop+document.documentElement.scrollTop;b.style.top=c.y+"px",b.style.left=c.x+"px",b.style.display="block",document.onclick=Interface.hideAllMenus,a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation()}},window.onload=Interface.init;